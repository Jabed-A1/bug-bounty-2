{% extends "base.html" %}

{% block title %}Testing Control - {{ target.name }}{% endblock %}

{% block content %}
<div class="testing-control">
    <h1><i class="fas fa-flask"></i> Testing Control: {{ target.name }}</h1>
    
    {% if not can_run %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        Target is disabled or paused. Testing cannot proceed.
    </div>
    {% endif %}

    <!-- TEST JOBS GRID -->
    <div class="section">
        <h2><i class="fas fa-spinner"></i> Test Jobs</h2>
        
        <div class="test-jobs-grid">
            <!-- Running Tests -->
            <div class="jobs-group">
                <h3>Running ({{ running_tests|length }})</h3>
                {% if running_tests %}
                    {% for job in running_tests %}
                    <div class="test-card running">
                        <div class="test-header">
                            <span class="badge payload">{{ job.payload_category }}</span>
                            <span class="progress-val">{{ job.requests_sent }}/{{ job.responses_received }}</span>
                        </div>
                        <div class="test-body">
                            <div class="info">
                                <small>Candidate ID: {{ job.candidate_id }}</small> | <small>Rate: {{ job.rate_limit_per_second }}/sec</small>
                            </div>
                            {% if job.vulnerability_found %}
                            <div class="vuln-found"><i class="fas fa-exclamation-circle"></i> VULNERABILITY FOUND</div>
                            {% endif %}
                        </div>
                        <div class="test-footer">
                            <button class="btn btn-danger btn-sm" onclick="stopTest({{ job.id }})">
                                <i class="fas fa-stop"></i> STOP
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="empty">No running tests</p>
                {% endif %}
            </div>

            <!-- Queued Tests -->
            <div class="jobs-group">
                <h3>Queued ({{ queued_tests|length }})</h3>
                {% if queued_tests %}
                    {% for job in queued_tests %}
                    <div class="test-card queued">
                        <div class="test-header">
                            <span class="badge payload">{{ job.payload_category }}</span>
                            <span class="status">QUEUED</span>
                        </div>
                        <div class="test-body">
                            <small>Candidate ID: {{ job.candidate_id }}</small>
                        </div>
                        <div class="test-footer">
                            <button class="btn btn-sm btn-danger" onclick="stopTest({{ job.id }})">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="empty">No queued tests</p>
                {% endif %}
            </div>

            <!-- Completed Tests -->
            <div class="jobs-group">
                <h3>Done ({{ done_tests|length }})</h3>
                {% if done_tests %}
                    {% for job in done_tests[:5] %}
                    <div class="test-card done">
                        <div class="test-header">
                            <span class="badge payload">{{ job.payload_category }}</span>
                            <span class="duration">{{ job.duration_seconds }}s</span>
                        </div>
                        <div class="test-body">
                            <small>Requests: {{ job.requests_sent }} | Responses: {{ job.responses_received }}</small>
                            {% if job.vulnerability_found %}
                            <div class="vuln-badge"><i class="fas fa-check-circle"></i> VULNERABLE</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="empty">No completed tests</p>
                {% endif %}
            </div>

            <!-- Failed Tests -->
            <div class="jobs-group">
                <h3>Failed ({{ failed_tests|length }})</h3>
                {% if failed_tests %}
                    {% for job in failed_tests %}
                    <div class="test-card failed">
                        <div class="test-header">
                            <span class="badge payload">{{ job.payload_category }}</span>
                            <span class="status">FAILED</span>
                        </div>
                        <div class="test-body">
                            {% if job.error_message %}
                            <div class="error-msg">{{ job.error_message[:80] }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="empty">No failed tests</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- APPROVED CANDIDATES READY FOR TESTING -->
    <div class="section">
        <h2><i class="fas fa-play-circle"></i> Approved Candidates Ready for Testing</h2>
        <div class="candidates-for-testing">
            {% set approved_no_tests = [] %}
            {% for candidate in approved_candidates %}
                {% if not (candidate.id in [t.candidate_id for t in test_jobs]) %}
                    {% set _ = approved_no_tests.append(candidate) %}
                {% endif %}
            {% endfor %}

            {% if approved_no_tests %}
                {% for candidate in approved_no_tests %}
                <div class="ready-candidate">
                    <div class="candidate-info">
                        <div class="url">{{ candidate.endpoint_url }}</div>
                        <div class="method">{{ candidate.http_method }}</div>
                        <div class="details">
                            <span class="confidence">{{ (candidate.confidence_score * 100)|int }}% confidence</span>
                            <span class="risk risk-{{ candidate.risk_level|lower }}">{{ candidate.risk_level }}</span>
                        </div>
                    </div>
                    <div class="payload-select">
                        <select id="payload_{{ candidate.id }}" class="payload-dropdown">
                            <option value="">-- Select Payload --</option>
                            <option value="xss">XSS</option>
                            <option value="sqli">SQL Injection</option>
                            <option value="lfi">Local File Inclusion</option>
                            <option value="api">API Abuse</option>
                            <option value="auth">Authentication</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="startTest({{ candidate.id }})">
                        <i class="fas fa-flask"></i> START TEST
                    </button>
                </div>
                {% endfor %}
            {% else %}
                <p class="empty">No new approved candidates ready for testing</p>
            {% endif %}
        </div>
    </div>

    <!-- FINDINGS -->
    <div class="section">
        <h2><i class="fas fa-bug"></i> Findings ({{ findings|length }})</h2>
        
        <!-- Unreviewed Findings -->
        {% if unreviewed_findings %}
        <div class="findings-subsection">
            <h3><i class="fas fa-clock"></i> Pending Review ({{ unreviewed_findings|length }})</h3>
            <div class="findings-grid">
                {% for finding in unreviewed_findings %}
                <div class="finding-card unreviewed severity-{{ finding.severity|lower }}">
                    <div class="finding-header">
                        <span class="vuln-type">{{ finding.vulnerability_type }}</span>
                        <span class="severity">{{ finding.severity }}</span>
                    </div>
                    <div class="finding-body">
                        <div class="poc">
                            <strong>Proof of Concept:</strong>
                            <pre>{{ finding.proof_of_concept[:150] }}</pre>
                        </div>
                        {% if finding.impact_description %}
                        <div class="impact">
                            <strong>Impact:</strong> {{ finding.impact_description[:100] }}...
                        </div>
                        {% endif %}
                    </div>
                    <div class="finding-actions">
                        <button class="btn btn-success btn-xs" onclick="confirmFinding({{ finding.id }})">
                            <i class="fas fa-check"></i> CONFIRM
                        </button>
                        <button class="btn btn-warning btn-xs" onclick="rejectFinding({{ finding.id }})">
                            <i class="fas fa-question"></i> UNCONFIRMED
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Confirmed Findings -->
        {% if confirmed_findings %}
        <div class="findings-subsection">
            <h3><i class="fas fa-check-circle"></i> Confirmed ({{ confirmed_findings|length }})</h3>
            <table class="findings-table">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Test Job</th>
                        <th>Confirmed At</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for finding in confirmed_findings %}
                    <tr class="severity-{{ finding.severity|lower }}">
                        <td><strong>{{ finding.vulnerability_type }}</strong></td>
                        <td><span class="badge">{{ finding.severity }}</span></td>
                        <td>#{{ finding.test_job_id }}</td>
                        <td>{{ finding.verified_at.strftime('%H:%M:%S') if finding.verified_at else '-' }}</td>
                        <td>{{ finding.reviewer_notes or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        {% if not unreviewed_findings and not confirmed_findings %}
        <p class="empty">No findings yet</p>
        {% endif %}
    </div>
</div>

<style>
.testing-control {
    padding: 20px;
    background: #0a0e27;
    color: #e0e0e0;
}

.testing-control h1, .testing-control h2 {
    margin-bottom: 20px;
    color: #fff;
}

.testing-control h2 {
    font-size: 18px;
    border-bottom: 2px solid #0ea5e9;
    padding-bottom: 10px;
}

.alert {
    padding: 12px 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.alert-danger {
    background: rgba(255, 107, 107, 0.15);
    border: 1px solid #ff6b6b;
    color: #ff6b6b;
}

.section {
    margin-bottom: 30px;
}

.test-jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.jobs-group {
    background: #1a1f3a;
    border: 1px solid #2a3a5a;
    border-radius: 8px;
    padding: 15px;
}

.jobs-group h3 {
    margin: 0 0 15px 0;
    font-size: 14px;
    color: #a8d8ff;
    font-weight: 600;
}

.test-card {
    background: rgba(255, 255, 255, 0.03);
    border-left: 4px solid #666;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 10px;
}

.test-card.running { border-left-color: #ff6b6b; background: rgba(255, 107, 107, 0.08); }
.test-card.queued { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.08); }
.test-card.done { border-left-color: #10b981; background: rgba(16, 185, 129, 0.08); }
.test-card.failed { border-left-color: #ff6b6b; background: rgba(255, 107, 107, 0.08); }

.test-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge.payload {
    background: #0ea5e9;
    color: white;
}

.test-body {
    font-size: 12px;
    color: #aaa;
    margin-bottom: 8px;
}

.vuln-found {
    color: #ff6b6b;
    font-weight: 600;
    margin-top: 6px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.vuln-badge {
    color: #10b981;
    font-weight: 600;
    font-size: 11px;
}

.test-footer {
    display: flex;
    gap: 5px;
}

.empty {
    text-align: center;
    color: #666;
    padding: 20px;
    font-style: italic;
    font-size: 12px;
}

.candidates-for-testing {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 15px;
}

.ready-candidate {
    background: #1a1f3a;
    border: 2px solid #0ea5e9;
    border-radius: 6px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.candidate-info {
    flex: 1;
}

.candidate-info .url {
    color: #a8d8ff;
    font-weight: 600;
    margin-bottom: 5px;
    word-break: break-all;
    font-size: 13px;
}

.candidate-info .method {
    display: inline-block;
    padding: 2px 6px;
    background: #0ea5e9;
    color: white;
    border-radius: 3px;
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 5px;
}

.candidate-info .details {
    font-size: 11px;
    color: #888;
}

.candidate-info .confidence {
    margin-right: 10px;
}

.risk {
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 600;
}

.risk-low { background: rgba(14, 165, 233, 0.2); color: #0ea5e9; }
.risk-medium { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
.risk-high { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
.risk-critical { background: rgba(255, 23, 68, 0.2); color: #ff1744; }

.payload-select {
    min-width: 120px;
}

.payload-dropdown {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #2a3a5a;
    background: rgba(255, 255, 255, 0.05);
    color: #e0e0e0;
    font-size: 12px;
}

.payload-dropdown option {
    background: #1a1f3a;
    color: #e0e0e0;
}

.findings-subsection {
    margin-bottom: 25px;
}

.findings-subsection h3 {
    margin: 0 0 15px 0;
    font-size: 14px;
    color: #a8d8ff;
}

.findings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 15px;
}

.finding-card {
    background: rgba(255, 255, 255, 0.03);
    border-left: 4px solid #666;
    border-radius: 6px;
    padding: 15px;
}

.finding-card.severity-critical { border-left-color: #ff1744; background: rgba(255, 23, 68, 0.08); }
.finding-card.severity-high { border-left-color: #ff6b6b; background: rgba(255, 107, 107, 0.08); }
.finding-card.severity-medium { border-left-color: #f59e0b; background: rgba(245, 158, 11, 0.08); }
.finding-card.severity-low { border-left-color: #0ea5e9; background: rgba(14, 165, 233, 0.08); }

.finding-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.vuln-type {
    font-weight: 600;
    color: #e0e0e0;
}

.severity {
    padding: 4px 8px;
    border-radius: 3px;
    background: rgba(255, 255, 255, 0.1);
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.finding-body {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 10px;
    font-size: 12px;
}

.poc {
    margin-bottom: 10px;
}

.poc pre {
    background: rgba(0, 0, 0, 0.3);
    padding: 8px;
    border-radius: 3px;
    overflow-x: auto;
    font-size: 10px;
    color: #a8d8ff;
    margin: 5px 0 0 0;
    max-height: 80px;
}

.impact {
    color: #aaa;
    font-size: 11px;
}

.finding-actions {
    display: flex;
    gap: 8px;
}

.findings-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    background: #1a1f3a;
    border-radius: 6px;
    overflow: hidden;
}

.findings-table thead {
    background: rgba(255, 255, 255, 0.05);
}

.findings-table th {
    padding: 12px;
    text-align: left;
    color: #888;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 11px;
}

.findings-table td {
    padding: 12px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.findings-table tr.severity-critical { background: rgba(255, 23, 68, 0.05); }
.findings-table tr.severity-high { background: rgba(255, 107, 107, 0.05); }

.btn {
    padding: 8px 12px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
    font-size: 12px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.btn-primary { background: #0ea5e9; color: white; }
.btn-primary:hover { background: #0084c9; }

.btn-success { background: #10b981; color: white; }
.btn-success:hover { background: #059669; }

.btn-warning { background: #f59e0b; color: white; }
.btn-warning:hover { background: #d97706; }

.btn-danger { background: #ff6b6b; color: white; }
.btn-danger:hover { background: #ff4a4a; }

.btn-sm { padding: 6px 10px; font-size: 11px; }
.btn-xs { padding: 4px 8px; font-size: 10px; }
</style>

<script>
function startTest(candidateId) {
    const payload = document.getElementById(`payload_${candidateId}`).value;
    if (!payload) {
        alert('Please select a payload category');
        return;
    }
    
    if (confirm(`Start testing with ${payload}?`)) {
        fetch(`/control/testing/${candidateId}/start`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ payload_category: payload })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Test started: ' + data.message);
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function stopTest(jobId) {
    if (confirm('Stop this test job?')) {
        fetch(`/control/testing/${jobId}/stop`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                location.reload();
            });
    }
}

function confirmFinding(findingId) {
    const notes = prompt('Add notes (optional):', '');
    if (notes !== null) {
        fetch(`/control/findings/${findingId}/review`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirmed: true, notes: notes })
        })
        .then(r => r.json())
        .then(data => {
            alert(data.message);
            location.reload();
        });
    }
}

function rejectFinding(findingId) {
    const notes = prompt('Why unconfirmed?', '');
    if (notes !== null) {
        fetch(`/control/findings/${findingId}/review`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirmed: false, notes: notes })
        })
        .then(r => r.json())
        .then(data => {
            alert(data.message);
            location.reload();
        });
    }
}

// Auto-refresh if tests running
setInterval(function() {
    if (document.querySelector('.test-card.running')) {
        location.reload();
    }
}, 5000);
</script>
{% endblock %}
